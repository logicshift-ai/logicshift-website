<!-- Cal floating-popup embed code begins -->
<div id="cal-script-container"></div>

<script type="text/javascript">
  function getCurrentTheme() {
    return document.documentElement.classList.contains("dark") ? "dark" : "light";
  }

  function loadCalScript() {
    // Clean up previous embeds
    document.querySelectorAll("cal-modal-box, cal-floating-button").forEach(el => el.remove());
    document.querySelectorAll('[id^="cal-modal-box"]').forEach(el => el.remove());
    const container = document.getElementById("cal-script-container");
    container.innerHTML = "";

    // Create and insert script
    const script = document.createElement("script");
    script.type = "text/javascript";
    script.async = true;
    script.innerHTML = `
      (function (C, A, L) {
        let p = function (a, ar) { a.q.push(ar); };
        let d = C.document;
        C.Cal = C.Cal || function () {
          let cal = C.Cal;
          let ar = arguments;
          if (!cal.loaded) {
            cal.ns = {};
            cal.q = cal.q || [];
            d.head.appendChild(d.createElement("script")).src = A;
            cal.loaded = true;
          }
          if (ar[0] === L) {
            const api = function () { p(api, arguments); };
            const namespace = ar[1];
            api.q = api.q || [];
            if (typeof namespace === "string") {
              cal.ns[namespace] = cal.ns[namespace] || api;
              p(cal.ns[namespace], ar);
              p(cal, ["initNamespace", namespace]);
            } else p(cal, ar);
            return;
          }
          p(cal, ar);
        };
      })(window, "https://app.cal.com/embed/embed.js", "init");

      Cal("init", "30min", { origin: "https://cal.com" });

      Cal.ns["30min"]("floatingButton", {
        calLink: "taral.dev/30min",
        config: { layout: "month_view" },
        hideButtonIcon: false,
        buttonText: "Free Demo",
        buttonColor: "#FFE879",
        buttonTextColor: "#000000"
      });

      Cal.ns["30min"]("ui", {
        cssVarsPerTheme: {
          light: { "cal-brand": "#ffffff" },
          dark: { "cal-brand": "#0F1A17" }
        },
        theme: "${getCurrentTheme()}",
        hideEventTypeDetails: false,
        layout: "month_view"
      });
    `;
    container.appendChild(script);
  }

  function fixCalButtonZindexSmoothly() {
    const observer = new MutationObserver(() => {
      const calButton = document.querySelector("cal-floating-button");
      if (calButton) {
        const shadowRoot = calButton.shadowRoot;
        if (shadowRoot) {
          const button = shadowRoot.querySelector("button");
          if (button) {
            // First hide it to prevent sudden jumps
            button.style.visibility = "hidden";

            requestAnimationFrame(() => {
              button.style.zIndex = "1000"; // Set correct z-index smoothly
              button.style.visibility = "visible"; // Then make it visible
              observer.disconnect(); // Stop observing
            });
          }
        }
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadCalScript();
    fixCalButtonZindexSmoothly();

    const themeSwitcher = document.querySelector('[data-theme-switcher]');
    if (themeSwitcher) {
      themeSwitcher.addEventListener("change", () => {
        setTimeout(() => {
          loadCalScript();
          fixCalButtonZindexSmoothly();
        }, 300);
      });
    }
  });
</script>
<!-- Cal floating-popup embed code ends -->
